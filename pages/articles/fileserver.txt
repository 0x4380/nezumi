====== fileserver ======
<sub>{{fileserver.odt|Original file}}</sub>

====== моем файлы чисто-чисто-чисто\\ или идеальный сервер для идеальной файлопомойки ======

крис касперски, ака мыщъх, a.k.a. nezumi no-email

**администраторы накопили огромный опыт по воздвижению и эксплуатации "бюджетных" файловых серверов, среди которых с большим отрывом лидируют сервера на базе ****MS W2K3****, ставшим стандартом де-факто. никсы в этой роли смотрятся недостаточно убедительно, доставляя техническому персоналу кучу проблем. впрочем, ****W2K3 ****тоже не идеал и чтобы раскрыть его потенциал, а заодно помочь начинающим администраторам избежать классических ошибок, и была написана эта статья**

===== введение =====

Локальные сети начинались с файловых серверов. Ими же они по сути дела и закончились. Достаточно многие сидят под SQL, WEB, etc, но в файловые сервера используют еще больше народу: дома, в офисе, в корпоративной среде и так далее, вплоть до глобальных распределенных систем с кучей точек доступа по всему миру. Заниматься глобализмом мы не будем, переложив решение проблем планетарного масштаба на чужие плечи. В конце-концов, имея деньги, можно купить лучшее оборудование, нанять лучших специалистов: инженеров, администраторов, "белых хакеров"…

Воздвигнуть добротный файловый сервер в рамках скромной локальной сети гораздо сложнее. Бюджетный вариант уже давно стал синонимом "это, конечно, дерьмо, но что вы хотели за такие деньги?". Как говорится, не все то икра, что черное. Но ведь и не всякая икра — черная! Чем стремиться раздобыть дешевую и паршивую черную икру, не лучше ли за те же самые деньги наслаждаться доброкачественной красной?!

{{fileserver_Image_0.jpg?287}}

Рисунок 1 икра. я сказал — икра! и никаких компьютеров!!!

===== помойка малая =====

Внешние жесткие диски с Ethernet-интерфейсом активно теснят полноценные файловые сервера, воздвигаемые на базе выделенных PC, встречаясь не только в домашних сетях, но и в офисах самых разных контор.

Достоинства: низкая цена (особенно в пересчете на один гигабайт), высокая масштабируемость (закончилось дисковое пространство? просто покупаем еще один винт и втыкаем в порт), относительная безглючность (работают они под сильно урезанным Linux'ом, который, как известно, не зависает), предельно низкое энергопотребление (а, следовательно, более дешевая UPS, обеспечивая их бесперебойным питанием, в отсутствии которого говорить о сохранности информации можно только в переносном метафизическом смысле), неприхотливость (внешние жесткие диски не требуют никакого обслуживания, ну разве что периодически полировать поверхность, да раз в несколько лет менять масло в подшипниках), невосприимчивость к большинству хакерских атак (Linux вообще намного лучше защищен, чем Windows, чтобы там ни утверждала Microsoft). Плюс ко всему вышеперечисленному: компактность (очень важное обстоятельство для мини-офисов и домашних сетей).

Недостатки: полная неуправляемость (внешний диск представляет "вещь в себе", работающую на автопилоте и не желающую подчиняться воле администратора), невозможность запуска антивируса внутри "коробки" (а вне "коробки" антивирус съедает всю пропускную способность локальной сети), практически непреодолимые трудности с обновлением ядра и наложением заплаток на него и на "Самбу" (Linux, конечно, штука хорошая, но дыры в нем все-таки обнаруживаются, и если их не латать, "коробка" может заразиться вирусом или руткитом, которого совершено нереально выковырять и который часто ведет к краху системы, вынуждая администратора разбирать "коробку", вытягивая оттуда жесткий диск, подключая его к PC – если, конечно, разработчики последнего не отодрали интерфейсный разъем, что довольно часто случается). В эту же корзину попадают аппаратные отказы самого диска (и ведь RAID на базе внешних жестких дисков никак не организуешь), сложности резервирования и поиска информации, связанные с отсутствием служб индексирования и журналирования, которые опять-таки не работают через Ethernet. Про разграничение доступа (вернее, отсутствие такого) мы вообще даже не говорим.

В общем, внешние жесткие диски не самый плохой вариант и как файловые сервера для домашних сетей и небольших офисов (где все равно никто не заботится ни о разграничении доступа, ни о резервировании) они вполне приемлемы. Какой смысл ставить PC, используя его в режиме "внешнего жесткого диска"?! А ведь именно в таком режиме большинство файловых серверов и работает! Переход на внешние жесткие диски в этом случае экономит деньги и увеличивает надежность, сокращая количество отказов и затрудняя атаки на сервер. Что касается больших корпоративных сетей, то там внешние жесткие диски могут вполне успешно "симбиотить" с настоящими файловыми серверами, используясь для хранения разделяемых данных, некритичных к разрушению.

{{fileserver_Image_1.jpg?553}}

Рисунок 2 внешний жесткий диск с Ethernet-интерфейсом со снятой крышкой

===== помойка большая =====

Воздвигнуть сервер можно и на основе PC. Особенно, если это сервер — файловый. Ему ни к чему большие процессорные мощности (многопроцессорные машины ничуть не увеличивают быстродействия), избыток оперативной памяти превращается в бесполезный балласт, а скоростные RAID-контроллеры упираются в бутылочное горлышко тонкой витой пары. Список ненужных вещей можно продолжать бесконечно, а бесконечность штука коварная, поэтому лучше остановившись на формулировке: нетребовательность к аппаратной конфигурации. Сойдет любое (ну, практически) любое железо, что есть под рукой.

Однако, тут все-таки не обходится без тонкостей…

{{fileserver_Image_2.jpg?353}}

Рисунок 3 большой солидный сервер

==== гига бить или не бить? ====

Национальным стандартом де-факто стал стамегабитный Ethernet. Гигабитый уже давно не новость, но большого распространения он так и не получил, а все потому, что разницу между десятимегабитным и стамегабитным Ethernet'ом пользователи почувствовали сразу — все летает и ничего не тормозит. Конечно, "летает" — в переносном смысле. Локальный жесткий диск реально быстрее. А сеть медленнее. Что изменяет переход на гигабитные каналы?

А ничего! Диск — быстрее, сеть — медленнее. Не летает, но и не тормозит. Да, конечно, в гигабитный канал вмещается намного больше данных и в крупных сетях разница все-таки выпирает наружу, однако, это должна быть действительно крупная и сильно загруженная сеть, иначе выигрыш в производительности можно зафиксировать только с помощью хронометра. Но! Крупные сети строятся совсем по другой схеме. Они разбиваются на сегменты, администраторы заботятся о балансировании нагрузки…

Короче, в 99% случаях правильно спроектированная сеть не испытывает острой потребности в гигабитных каналах. А неправильной и гигабита будет мало. Учитывая, что гигабитная инфрастуктура требует определенных инвестиций, как в оборудование, так и в топологию самой сети, целесообразность ее использования — предмет острых дискуссий, которые мы обойдем стороной, оставшись верными старому-доброму ста-мегабитному Ethernet'у.

==== с матрицей и без ====

Файловому серверу позарез нужна матрица из нескольких дисков, объединенная в общий RAID — вот такие мысли есть у народа. Какой же это файловый сервер без RAID'а?! И зачем тогда вообще нужны матрицы?! Ошибочность этого мнения дорого стоит. RAID'ы они вообще мягко говоря совсем для другого предназначены:

а) увеличения пропускной способности дискового ввода/вывода (актуально для баз данных, станций цифрового видео-монтажа, совершенно не актуально для файловых серверов);

б) работы с файлами/разделами очень большого размера (ныне вообще не актуально, монтируемые файловые системы и огромные объемы современных винчестеров делают свое дело — и чем дальше, тем больше);

в) сервера критичные к отказу в обслуживании с окном восстановления меньше часа или даже вообще без такового (тот же самый функционал обеспечивает программный RAID плюс hot-plug на дешевом бюджетном IDA SATA).

RAID'ы (в общем случае) практически не уменьшают вероятности потери данных, поскольку, отказ жесткого диска далеко не единственная (и даже не самая частая) причина аварии. Более того, в 9 из 10 случаев винчестер умирает не сразу, а постепенно. Диагностические утилиты позволяют предвидеть возможный выход из строя за несколько дней, недель, а то и месяцев. К тому же, RAID'ы все равно не отменяют необходимость резервирования (поскольку, не предотвращают логические разрушения, хакерские и вирусные атаки), а если у нас есть свежий бэкап — так ли нам нужен RAID?!

Дешевые RAID'ы (особенно те, что встроены в материнскую плату) — весьма вредоносная штука. Они содержат множество ошибок, приводящих к возможным потерям данных и славятся внезапными отказами, а найти плату с совместимым или идентичным RAID'ом не так-то просто. Внешние RAID'ы (контроллеры, вставляемые в слот) более надежны, однако, бюджетные модели все равно глючат, а стоимость дорогих соизмерима со стоимостью всего сервера в целом. Смысл?!

А как на счет программного RAID'а?! Идея, конечно, заманчивая, но винчестеры, посаженные на разные порты контроллера, дадут намного больший выигрыш в производительности, если файлы, запрашиваемые пользователями, равномерно распределены между ними. Так что чем больше у нас винчестеров, _не_ объединенных в матрицу, тем выше производительность, причем, реально выше, а не по хронометру (хинт: винчестеры медленно ищут файлы, но быстро их читают, а потому параллельный RAID не увеличивает производительности, тогда как пара независимых жестких дисков — вполне).

==== скупой платит дважды ====

Мифы про то, что, дескать, существуют в мире файловые системы, не поддержанные фрагментации, немедленно разоблачаются, как только эти файловые системы приобретают популярность. Фрагментация была есть и будет, от этого никуда не уйдешь. А достойных фрагментаторов… гм, особенно с учетом большого количества открытых файлов на сервере… Короче, всякий раздел обречен изначально обречен на неуклонную деградацию производительности и под NTFS еще нет дефрагментаторов, способных восстановить больного на 100%. Единственная мера — реформат с повторной заливкой файлов, временно сохраненных в другом месте. Но это слишком радикально.

Замедлить рост темпов падения производительности ( (с) М.С. Горбачев) помогает правильный выбор размера кластера. Чем больше — тем лучше. Да, конечно, с увеличением размера кластера возрастают и потери дискового пространства, т.к. NTFS не умеет использовать пустые хвосты кластеров (UFS, поддерживаемая FreeBSD, – умеет), однако, дисковое пространство стоит копейки, а низкая производительность компьютера оборачивается низкой производительностью труда, вылетая в десятки и даже тысячи рублей.

==== возврат к первобытно общинному строю ====

В древние времена народ жил в пещерах и все члены племени знали друг друга. Потом народ разбежался по квартирам, со всеми маньяками, насильниками и прочими хакерами, которые так зашифровались, что их и не выкупишь. Системы безопасности, строгая политика разграничения доступа. Группы, пароли, привилегии…

Вот только офисы — это те же самые пещеры, только с евроремонтом. И понятия там первобытнообщинные. Кто трогал мой файл и весь вытрогал?! Кто съел мой бутерброд, утянул чайник и исписал весь маркер?! Верните чайник на место! И файл мой отдайте! Как это так: access denied?!

Бедный администратор! Он всю неделю планировал систему разграничения доступа. Ага, Маша и Катя — они у нас в бухгалтерии и потому члены одной группы (они вообще лесбиянки и работают попеременно то с одного, то с другого компьютера, а чаще всего вообще никак не работают, а ищут себе любовниц на love.mail.ru). А вот Сара она уже давно не… В смысле она вообще шарит в компьютерах, web-дизайне и пишет движок для сайта компании на чистом PHP. Зачем ей доступ к файлам Маши и Кати?! Выделим ее в отдельную группу!

А вот теперь Борис (он у нас вообще юрист) хочет видеть на сайте компании красивые графики, визуализирующие отчетность Маши с Катей. Что делает Сара? Правильно, пинает администратора, чтобы он ей дал… в смысле доступ. К файлам. Тоже самое делает и Борис. В результате, рано или поздно, но в историческом плане _неизбежно_, мы приходим к полному уравнению в правах с незначительными исключениями для администратора (и, возможно, хоть и маловероятно, некоторых других, приближенных к нему, лиц).

Разграничение доступа реально необходимо лишь очень большим компаниям. Во всех остальных — это головная боль в чистом виде. Вместо того, чтобы заниматься DELом, сотрудники бегают по отделам в поисках лиц, имеющих доступ к данному файлу. Даже если это архив, который на первый взгляд, нужен только тому, кто занимается резервированием и который желательно защитить от бесконтрольного доступа. Но, увы, жизненные реалии таковы, что и архив нужен всем, пускай не постоянно, а время от времени.

Конечно, понятие конфиденциальности никто не отменял и далеко не всем сотрудникам по долгу службы дозволено видеть файлы своих соседей. В теории. На практике же, если в компании завелся вредитель — он их увидит даже если администратор воздвигнет многоступенчатую систему защиты. Если же вредителей нет — от кого нам тогда защищаться?! Вопрос риторический, четкого ответа не имеющий. Умные администраторы отличаются от глупых тем, что не занимаются самодеятельностью, а раздают сотрудникам права, спущенные вышестоящим руководством, которому и приходится отдуваться за все разборки Маши, Сары и Бориса.

==== квоты ====

Так все-таки — кто увел наш любимый чайник? Уже второй день весь отдел без чаю. Ну о какой производительности труда тут может идти речь?! Наглядное свидетельство того, что если кресло не привязать цепью, то стоит только оторвать свой зад, как опускать его будет уже не куда. Потому как кресло кто-то стащил. Разбирайся потом кто. Точно так и с дисковым пространством. В отличии от разграничения доступа, дисковые квоты — великое дело!

Винчестеры они, конечно, очень большие, но все-таки не резиновые. А пользователи они же… то создают кучу копий одного и того же файла, рассованного по разным папкам, то притаранят несколько гигабайт фотографий в стиле Маша с Катей покоряют Крым. Про музыку, клипы и порнуху мы вообще не говорим. Даже если админ выделил под это дело целый раздел, пользователи любят держать файлы в состоянии полного хаоса.

В чем проблема?! А проблема-то в резервировании, обычно осуществляемом на DVD, объем которым намного меньше объема жестких дисков и потому сохранение всех файлов сервера вылетает в копеечку, способствуя быстрому разорению фирмы. С другой стороны, объем реально нужных файлов не так уж и велик. Главное — не резервировать всякий мусор. А то у Маши новая супер-мегапискельная камера, да еще и с записью видео.

Чтобы прищемить беспредельниц как раз и нужны квоты. Хочет Маша залить на сервер свои фотографии – пускай это делает под именем юзера Хипарь (в смысле свалка всяких ненужных вещей, типа Куча, по-английски heap), а под рабочие файлы ей выделить максимум гигабайт — заодно и дубликаты файлов со временными копиями поудаляет.

==== игры теней ====

Как лучше всего проводить резервирование. Разумеется, по расписанию. Когда все пользователи ушли, закрыли все файлы и ничто не мешает их копировании (файлы, открываемые на запись, обычно блокируются). Вот только нереально это. Кто-то, открыл кучу файлов и ушел домой, оставив компьютер включенным. Или фирма работает в три смены. Да мало ли еще что…

{{fileserver_Image_3.jpg?553}}

Рисунок 4 тени исчезают в полдень

Вот специально для этого в S2K3 реализовано так называемое "теневое копирование" (shadow copies). Если говорить просто — то это фоновое копирование, осуществляемое на сектором уровне (вообще-то, кластерном, но кого заботят эти мелочи) и работающее в тесном взаимодействии с NTFS так, что копируются даже файлы открытые на запись и заблокированные от совместного чтения.

{{fileserver_Image_4.png?366}}

Рисунок 5 включение теневого копирования в S2K3

Теневое копирование поддерживает множество резервирующих программ (в том числе и штатная утилита MS Backup) и вникать в технические детали реализации для его использования в общем-то и не обязательно.А если все-таки такое желания возникает, пожалуйста! Лезем на сайт Microsoft и читаем техническую документацию: http://www.microsoft.com/windowsserver2003/techinfo/overview/scr.mspx (и не жалуемся, что на английском! На то она и Техническая Документация).

{{fileserver_Image_5.png?553}}

Рисунок 6 внимание! служба теневого копирования не свободна от ошибок и иногда не запускается! причем, об этом можно узнать только из журнала!

==== оборонная инициатива ABE ====

Аббревиатура ABE расшифровывается как Access Based Enumeration и представляет из себя секьюрную фичу, стоящую на страже безопасности данных. Как и следует из ее названия, ABE позволяет скрывать сам факт существования разделяемых ресурсов от определенных групп пользователей, включая ананимусов (то есть всех праздно шатающихся хакеров).

Теоретически это усложняет взлом, поскольку, хакеру необходимо не только подобрать пароль к ресурсу, но еще и угадать имя самого ресурса (например, имя папки с разделяемыми документами). Впрочем, как показывает практика, администраторы склонны давать разделяемым ресурсам вполне предсказуемые имена, а потому ABE не есть панацея.

С другой стороны, когда пользователь не видит ресурсов, к которым он не имеет прав доступа, он и не нервничает, и не задает глупых вопросов администратору (типа: а почему у меня не открывается папка Top-Security?!), так что использование ABE даже в мирных целях весьма перспективно. Подробнее об особенностях использования ABE можно прочить на блоге Microsoft: blogs.microsoft.co.il/blogs/erikr/archive/2008/06/28/access-based-enumeration-abe.aspx

{{fileserver_Image_6.png?468}}

Рисунок7 управление разделяемыми ресурсами

===== заключение =====

Конец статьи еще не означает конца всех проблем. С воздвижением сервера (не обязательно файлового) проблемы только начинаются. Собственно говоря, администратор представляет собой биокомпьютер, обслуживающий другие биокомпьютеры (пользователей), ну и попутно решающий стоит ли выливать воду из чайника через вентиляционные отверстия сервера или пускай пока живет. А вот когда окончательно достанут — точно выльет. Пока его чинят, он хоть немного отдохнет. "Его" —это администратора, "он" — в смысле сервер. Или наоборот?


